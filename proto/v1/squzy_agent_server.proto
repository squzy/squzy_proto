syntax = 'proto3';

package squzy.v1.agent;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

option go_package = "api";

service AgentServer {
  rpc Register (RegisterRequest) returns (RegisterResponse);
  rpc GetByAgentName (GetByAgentNameRequest) returns (GetAgentListResponse);
  rpc GetAgentById (GetAgentByIdRequest) returns (AgentItem);
  rpc UnRegister (UnRegisterRequest) returns (UnRegisterResponse);
  rpc GetAgentList (google.protobuf.Empty) returns (GetAgentListResponse);
  rpc SendMetrics (stream SendMetricsRequest) returns (google.protobuf.Empty);
}

message Metric {
  string agent_id = 1;
  // Should be set by user from env var
  string agent_name = 2;
  CpuInfo cpu_info = 3;
  MemoryInfo memory_info = 4;
  DiskInfo disk_info = 5;
  NetInfo net_info = 6;
  google.protobuf.Timestamp time = 7;
}

message SendMetricsRequest {
  // generated by server
  oneof msg {
    Metric metric = 1;
    Disconnect disconnect = 2;
  }
  message Disconnect {
    string agent_id = 1;
    google.protobuf.Timestamp time = 2;
  }
}

message GetAgentByIdRequest  {
  string agent_id = 1;
}

message CpuInfo {
  message CPU {
    double load = 1;
  }
  // protolint:disable:next REPEATED_FIELD_NAMES_PLURALIZED
  repeated CPU cpus = 1;
}

message MemoryInfo {
  message Memory {
    uint64 total = 1;
    uint64 used = 2;
    uint64 free = 3;
    uint64 shared = 4;
    double used_percent = 5;
  }
  Memory mem = 1;
  Memory swap = 2;
}

message DiskInfo {
  message Disk {
    uint64 total = 1;
    uint64 free = 2;
    uint64 used = 3;
    double used_percent = 4;
  }
  map<string, Disk> disks = 1;
}

message NetInfo {
  message Interface {
    uint64 bytes_sent = 1;
    uint64 bytes_recv = 2;
    uint64 packets_sent = 3;
    uint64 packets_recv = 4;
    // total number of errors while receiving
    uint64 err_in = 5;
    // total number of errors while sending
    uint64 err_out = 6;
    // total number of incoming packets which were dropped
    uint64 drop_in = 7;
    // total number of outgoing packets which were dropped
    // (always 0 on OSX and BSD)
    uint64 drop_out = 8;
  }
  map<string, Interface> interfaces = 1;
}

enum AgentStatus {
  // Initial status
  AGENT_STATUS_UNSPECIFIED = 0;
  // Agent is runned but not send stat yet
  REGISTRED = 1;
  // Actually send stat
  RUNNED = 2;
  // Stopped to send stat
  DISCONNECTED = 3;
  // Unregistred
  UNREGISTRED = 4;
}

message GetByAgentNameRequest {
  string agent_name = 1;
}

message GetAgentListResponse {
  repeated AgentItem agents = 1;
}

message UnRegisterRequest {
  string id = 1;
  google.protobuf.Timestamp time = 2;
}

message UnRegisterResponse {
  string id = 1;
}

message RegisterRequest {
  // Name form env
  string agent_name = 1;
  HostInfo host_info = 2;
  google.protobuf.Timestamp time = 3;
  // interval for update
  int64 interval = 4;
}

message AgentItem {
  string id = 1;
  string agent_name = 2;
  AgentStatus status = 3;
  HostInfo host_info = 4;
}

message HostInfo {
  string host_name = 1;
  string os = 2;
  PlatformInfo platform_info = 3;
}

message PlatformInfo {
  string name = 1;
  string family = 2;
  string version = 3;
}

message RegisterResponse {
  string id = 1;
}